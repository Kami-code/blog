<!doctype html>
<html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>complier-lab5 - Ryan &#039;s website</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="Ryan&#039;s blog"><meta name="msapplication-TileImage" content="/img/favicon.svg"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="Ryan&#039;s blog"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="This lab comes from SE3355 *Compilers*  lab5, which requires me to implement a complete runnable tiger compiler."><meta property="og:type" content="blog"><meta property="og:title" content="complier-lab5"><meta property="og:url" content="https://kami-code.com/2021/12/14/complier-lab5/"><meta property="og:site_name" content="Ryan &#039;s website"><meta property="og:description" content="This lab comes from SE3355 *Compilers*  lab5, which requires me to implement a complete runnable tiger compiler."><meta property="og:locale" content="en_US"><meta property="og:image" content="https://kami-code.com/2021/12/14/complier-lab5/image-20211214171419591.png"><meta property="og:image" content="https://kami-code.com/2021/12/14/complier-lab5/image-20211214181041023.png"><meta property="og:image" content="https://kami-code.com/2021/12/14/complier-lab5/image-20211214181331975.png"><meta property="og:image" content="https://kami-code.com/2021/12/14/complier-lab5/image-20211214181606771.png"><meta property="og:image" content="https://kami-code.com/2021/12/14/complier-lab5/image-20211214181944801.png"><meta property="article:published_time" content="2021-12-14T09:13:44.000Z"><meta property="article:modified_time" content="2021-12-25T18:46:43.268Z"><meta property="article:author" content="Kami-code"><meta property="article:tag" content="lab"><meta property="article:tag" content="compliers"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="/2021/12/14/complier-lab5/image-20211214171419591.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://kami-code.com/2021/12/14/complier-lab5/"},"headline":"complier-lab5","image":["https://kami-code.com/2021/12/14/complier-lab5/image-20211214171419591.png","https://kami-code.com/2021/12/14/complier-lab5/image-20211214181041023.png","https://kami-code.com/2021/12/14/complier-lab5/image-20211214181331975.png","https://kami-code.com/2021/12/14/complier-lab5/image-20211214181606771.png","https://kami-code.com/2021/12/14/complier-lab5/image-20211214181944801.png"],"datePublished":"2021-12-14T09:13:44.000Z","dateModified":"2021-12-25T18:46:43.268Z","author":{"@type":"Person","name":"Kami-code"},"publisher":{"@type":"Organization","name":"Ryan 's website","logo":{"@type":"ImageObject","url":"https://kami-code.com/img/logo.svg"}},"description":"This lab comes from SE3355 *Compilers*  lab5, which requires me to implement a complete runnable tiger compiler."}</script><link rel="canonical" href="https://kami-code.com/2021/12/14/complier-lab5/"><link rel="icon" href="/img/favicon.svg"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.2/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/css/justifiedGallery.min.css"><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script><!--!--><!--!--><meta name="generator" content="Hexo 5.4.0"></head><body class="is-2-column"><nav class="navbar navbar-main"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/logo.svg" alt="Ryan &#039;s website" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a><a class="navbar-item" href="/about">About</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus"><i class="fab fa-github"></i></a><a class="navbar-item search" title="Search" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-8-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2021-12-14T09:13:44.000Z" title="2021/12/14 下午5:13:44">2021-12-14</time></span><span class="level-item">Updated&nbsp;<time dateTime="2021-12-25T18:46:43.268Z" title="2021/12/26 上午2:46:43">2021-12-26</time></span><span class="level-item">20 minutes read (About 2954 words)</span></div></div><h1 class="title is-3 is-size-4-mobile">complier-lab5</h1><div class="content"><p>This lab comes from SE3355 *<strong>Compilers*</strong>  lab5, which requires me to implement a complete runnable tiger compiler.</p>
<span id="more"></span>

<p>​    致谢：Lab5的完成离不开<a target="_blank" rel="noopener" href="https://github.com/Girafboy/Compiler">Girafboy学长</a>仓库所提供的参考和思路，为了避免有抄袭之嫌，我将重新以我的思路阐述清楚我的代码。</p>
<p>​    首先明确，我们这个Lab5的目标是把做完escape analysis的AST转化为tree language(middle IR)，再转化为assem(lower IR)。正如院长所说，前4个Lab其实是把代码文本转化成了AST，只生成了一个IR，但是我们需要在Lab5一下子完成两个IR的转换和生成，并且我们生成tree language后，其实非常不好Debug，因为有各种各样的嵌套语句，也没有解释器来解析tree language，我们必须等到生成了assem后才能够被<a target="_blank" rel="noopener" href="https://ipads.se.sjtu.edu.cn/courses/compilers/Debug-in-tiger.html">汇编解释器</a>所解释执行。</p>
<h2 id="Part1-AST翻译成Tree-Language"><a href="#Part1-AST翻译成Tree-Language" class="headerlink" title="Part1 AST翻译成Tree Language"></a>Part1 AST翻译成Tree Language</h2><p>​    前半部分是根据AST翻译成tree language。这部分相对比较简单，但是一件很麻烦的事情就是translation和Lab4的semantic analysis是非常紧密地intertwine在一起的，如果我们希望在Translate中调用SemAnalyze，会导致大量的代码重构，基本上是一整个Lab4的工作量加上额外的Debug时间，并且还涉及到一个非常trivial，还是很麻烦的点：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">type::Ty *<span class="title">SemAnalyze</span><span class="params">(env::VEnvPtr venv, env::TEnvPtr tenv, <span class="keyword">int</span> labelcount,</span></span></span><br><span class="line"><span class="params"><span class="function">                       err::ErrorMsg *errormsg)</span>  <span class="keyword">override</span></span>;</span><br><span class="line"><span class="function">tr::ExpAndTy *<span class="title">Translate</span><span class="params">(env::VEnvPtr venv, env::TEnvPtr tenv,</span></span></span><br><span class="line"><span class="params"><span class="function">                          tr::Level *level, temp::Label *label,</span></span></span><br><span class="line"><span class="params"><span class="function">                          err::ErrorMsg *errormsg)</span>  <span class="keyword">override</span></span>;</span><br></pre></td></tr></table></figure>

<p>​    我们可以看到，在模板所提供的的接口定义中，Translate函数是没有labelcount参数的，所以它并不能判断某个break语句是否在某些循环语句的里面，我们必须使用SemAnalyze来判定这个错误，所以哪怕我们把语义分析的语句全部迁移到Translate中，还是会有这个问题。为了避免过于丑陋的实现，我在这里纠结了一段时间，不过后来我仔细地查看了Lab5的测试代码（而不是Lab5-part1，Lab5-part1测试脚本没有Semantic analysis阶段，误导了我很久），如下所示：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// Lab 4: semantic analysis</span></span><br><span class="line">    <span class="built_in">TigerLog</span>(<span class="string">&quot;-------====Semantic analysis=====-----\n&quot;</span>);</span><br><span class="line">    <span class="function">sem::ProgSem <span class="title">prog_sem</span><span class="params">(std::move(absyn_tree), std::move(errormsg))</span></span>;</span><br><span class="line">    prog_sem.<span class="built_in">SemAnalyze</span>();</span><br><span class="line">    absyn_tree = prog_sem.<span class="built_in">TransferAbsynTree</span>();</span><br><span class="line">    errormsg = prog_sem.<span class="built_in">TransferErrormsg</span>();</span><br><span class="line">&#125;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// Lab 5: escape analysis</span></span><br><span class="line">    <span class="built_in">TigerLog</span>(<span class="string">&quot;-------====Escape analysis=====-----\n&quot;</span>);</span><br><span class="line">    <span class="function">esc::EscFinder <span class="title">esc_finder</span><span class="params">(std::move(absyn_tree))</span></span>;</span><br><span class="line">    esc_finder.<span class="built_in">FindEscape</span>();</span><br><span class="line">    absyn_tree = esc_finder.<span class="built_in">TransferAbsynTree</span>();</span><br><span class="line">&#125;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// Lab 5: translate IR tree</span></span><br><span class="line">    <span class="built_in">TigerLog</span>(<span class="string">&quot;-------====Translate=====-----\n&quot;</span>);</span><br><span class="line">    <span class="function">tr::ProgTr <span class="title">prog_tr</span><span class="params">(std::move(absyn_tree), std::move(errormsg))</span></span>;</span><br><span class="line">    prog_tr.<span class="built_in">Translate</span>();</span><br><span class="line">    errormsg = prog_tr.<span class="built_in">TransferErrormsg</span>();</span><br><span class="line">&#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>​    所以虽然上课说应该在translation的时候做同时做类型检查的，在Lab中评测中还是没有要求的这么严格。为了避免在Translate阶段又做一遍类型检查，我对AST上的所有节点添加了一个成员type::Ty *type，这样我们做完SemAnalyze后就可以缓存住每个节点的真正类型，然后在Translate阶段使用。这样我们基本上就完成了做Translate的准备动作。</p>
<p>​    Translate接口的定义如下：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">tr::ExpAndTy *<span class="title">Translate</span><span class="params">(env::VEnvPtr venv, env::TEnvPtr tenv,</span></span></span><br><span class="line"><span class="params"><span class="function">                          tr::Level *level, temp::Label *label,</span></span></span><br><span class="line"><span class="params"><span class="function">                          err::ErrorMsg *errormsg)</span>  <span class="keyword">override</span></span>;</span><br></pre></td></tr></table></figure>

<p>​    解决掉Translate的关键就是理解level和label参数的含义，理解了自然后面就都好做了。</p>
<p>​    我们先来看label，涉及到label修改和使用的只有两处：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">tr::ExpAndTy *<span class="title">WhileExp::Translate</span><span class="params">(env::VEnvPtr venv, env::TEnvPtr tenv,</span></span></span><br><span class="line"><span class="params"><span class="function">                                  tr::Level *level, temp::Label *label,           </span></span></span><br><span class="line"><span class="params"><span class="function">                                  err::ErrorMsg *errormsg)</span>  </span>&#123;</span><br><span class="line">    tr::Exp *exp = <span class="literal">nullptr</span>;</span><br><span class="line">    temp::Label *done_label = temp::LabelFactory::<span class="built_in">NewLabel</span>();</span><br><span class="line">    tr::ExpAndTy *check_test = test_-&gt;<span class="built_in">Translate</span>(venv, tenv, level, label, errormsg);</span><br><span class="line">    tr::ExpAndTy *check_body = body_-&gt;<span class="built_in">Translate</span>(venv, tenv, level, done_label, errormsg);</span><br><span class="line">	......</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">tr::ExpAndTy *<span class="title">BreakExp::Translate</span><span class="params">(env::VEnvPtr venv, env::TEnvPtr tenv,</span></span></span><br><span class="line"><span class="params"><span class="function">                                  tr::Level *level, temp::Label *label,</span></span></span><br><span class="line"><span class="params"><span class="function">                                  err::ErrorMsg *errormsg)</span>  </span>&#123;</span><br><span class="line">    tree::Stm *stm = <span class="keyword">new</span> tree::<span class="built_in">JumpStm</span>(<span class="keyword">new</span> tree::<span class="built_in">NameExp</span>(label), <span class="keyword">new</span> std::vector&lt;temp::Label *&gt;(&#123;label&#125;));</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> tr::<span class="built_in">ExpAndTy</span>(<span class="keyword">new</span> tr::<span class="built_in">NxExp</span>(stm), type);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​    注意到for循环最终是规约到while的，所以for循环没有使用到label。这样我们就很清楚了，label就是为了让break语句跳出循环使用的。换句话说，就是循环中done:的位置。这样看来，如果我们希望在translation中一遍同时做类型检查，没有labelcount也无伤大雅，我们只需要判断label是不是等于外面传入的默认值即可。</p>
<p>​    接下来是level函数，它主要的意义就是负责static link。换句话说，如果我们在$level=k_1$的函数体中引用到了$level=k_2&lt;k_1$的变量，那么我们需要通过$k_1-k_2$次static link跳转，找到这个变量所在的frame，并且通过其InReg还是InFrame来获取到具体的值。</p>
<p>​    所以，level的修改只会出现在FunctionDec的时候：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">tr::Exp *<span class="title">FunctionDec::Translate</span><span class="params">(env::VEnvPtr venv, env::TEnvPtr tenv,</span></span></span><br><span class="line"><span class="params"><span class="function">                                tr::Level *level, temp::Label *label,</span></span></span><br><span class="line"><span class="params"><span class="function">                                err::ErrorMsg *errormsg)</span>  </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (FunDec *fundec : functions_-&gt;<span class="built_in">GetList</span>()) &#123;</span><br><span class="line">        type::TyList *formaltys = <span class="built_in">make_formal_tylist</span>(tenv, fundec-&gt;params_);</span><br><span class="line">        tr::Level *new_level = tr::Level::<span class="built_in">NewLevel</span>(level, fundec-&gt;name_, <span class="built_in">make_formal_esclist</span>(fundec-&gt;params_));</span><br><span class="line">		......</span><br><span class="line">        tr::ExpAndTy *entry = fundec-&gt;body_-&gt;<span class="built_in">Translate</span>(venv, tenv, funentry-&gt;level_, funentry-&gt;label_, errormsg);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="StaticLink的处理"><a href="#StaticLink的处理" class="headerlink" title="StaticLink的处理"></a>StaticLink的处理</h3><p>​    static link的核心逻辑如下所示：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">tree::Exp *<span class="title">StaticLink</span><span class="params">(tr::Level *target, tr::Level *level)</span> </span>&#123;</span><br><span class="line">    tree::Exp *staticlink = <span class="keyword">new</span> tree::<span class="built_in">TempExp</span>(reg_manager-&gt;<span class="built_in">FramePointer</span>());</span><br><span class="line">    <span class="keyword">while</span>(level != target)&#123;</span><br><span class="line">        frame::Access *sl = level-&gt;frame_-&gt;formals.<span class="built_in">back</span>();</span><br><span class="line">        staticlink = sl-&gt;<span class="built_in">ToExp</span>(staticlink);</span><br><span class="line">        level = level-&gt;parent_;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> staticlink;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​    当我们在某个函数中尝试使用一个变量的时候，我们需要在venv中找到此变量的定义层数，并且调用StaticLink函数找到对应的层数。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">tr::Exp *<span class="title">TranslateSimpleVar</span><span class="params">(tr::Access *access, tr::Level *level)</span> </span>&#123;</span><br><span class="line">    tree::Exp *real_fp = <span class="built_in">StaticLink</span>(access-&gt;level_, level);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> tr::<span class="built_in">ExExp</span>(access-&gt;access_-&gt;<span class="built_in">ToExp</span>(real_fp));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">tr::ExpAndTy *<span class="title">CallExp::Translate</span><span class="params">(env::VEnvPtr venv, env::TEnvPtr tenv,</span></span></span><br><span class="line"><span class="params"><span class="function">                                 tr::Level *level, temp::Label *label,</span></span></span><br><span class="line"><span class="params"><span class="function">                                 err::ErrorMsg *errormsg)</span>  </span>&#123;</span><br><span class="line">	......</span><br><span class="line">    <span class="keyword">auto</span> *list = <span class="keyword">new</span> tree::<span class="built_in">ExpList</span>();</span><br><span class="line">    <span class="keyword">for</span> (Exp* args_p:args_-&gt;<span class="built_in">GetList</span>()) &#123;</span><br><span class="line">        tr::ExpAndTy *check_arg = args_p-&gt;<span class="built_in">Translate</span>(venv, tenv, level, label, errormsg);</span><br><span class="line">        list-&gt;<span class="built_in">Append</span>(check_arg-&gt;exp_-&gt;<span class="built_in">UnEx</span>());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(!fun_entry-&gt;level_-&gt;parent_) &#123;</span><br><span class="line">        exp = <span class="keyword">new</span> tr::<span class="built_in">ExExp</span>(frame::<span class="built_in">externalCall</span>(func_-&gt;<span class="built_in">Name</span>(), list));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        list-&gt;<span class="built_in">Append</span>(<span class="built_in">StaticLink</span>(fun_entry-&gt;level_-&gt;parent_, level));</span><br><span class="line">        exp = <span class="keyword">new</span> tr::<span class="built_in">ExExp</span>(<span class="keyword">new</span> tree::<span class="built_in">CallExp</span>(<span class="keyword">new</span> tree::<span class="built_in">NameExp</span>(func_), list));</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> tr::<span class="built_in">ExpAndTy</span>(exp, type);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​    注意在CallExp中，如果我们是外部调用的话，不需要添加static link参数，因为外部调用要求不传入static link。</p>
<h3 id="外部调用的处理"><a href="#外部调用的处理" class="headerlink" title="外部调用的处理"></a>外部调用的处理</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">tree::Exp *<span class="title">externalCall</span><span class="params">(std::string s, tree::ExpList *args)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> tree::<span class="built_in">CallExp</span>(<span class="keyword">new</span> tree::<span class="built_in">NameExp</span>(temp::LabelFactory::<span class="built_in">NamedLabel</span>(s)), args);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="关系运算的翻译"><a href="#关系运算的翻译" class="headerlink" title="关系运算的翻译"></a>关系运算的翻译</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> EQ_OP:</span><br><span class="line"><span class="keyword">case</span> NEQ_OP:</span><br><span class="line">&#123;</span><br><span class="line">    tree::CjumpStm *stm;</span><br><span class="line">    <span class="built_in"><span class="keyword">switch</span></span> (oper_) &#123;</span><br><span class="line">        <span class="keyword">case</span> EQ_OP:</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">dynamic_cast</span>&lt;type::StringTy *&gt;(leftExpAndTy-&gt;ty_) != <span class="literal">nullptr</span>) &#123;</span><br><span class="line">                <span class="keyword">auto</span> expList = <span class="keyword">new</span> tree::<span class="built_in">ExpList</span>(&#123;leftExp, rightExp&#125;);</span><br><span class="line">                stm = <span class="keyword">new</span> tree::<span class="built_in">CjumpStm</span>(tree::RelOp::EQ_OP, frame::<span class="built_in">externalCall</span>(<span class="string">&quot;string_equal&quot;</span>, expList), <span class="keyword">new</span> tree::<span class="built_in">ConstExp</span>(<span class="number">1</span>), <span class="literal">nullptr</span>, <span class="literal">nullptr</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                stm = <span class="keyword">new</span> tree::<span class="built_in">CjumpStm</span>(tree::RelOp::EQ_OP, leftExp, rightExp, <span class="literal">nullptr</span>, <span class="literal">nullptr</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> NEQ_OP:</span><br><span class="line">            stm = <span class="keyword">new</span> tree::<span class="built_in">CjumpStm</span>(tree::RelOp::NE_OP, leftExp, rightExp, <span class="literal">nullptr</span>, <span class="literal">nullptr</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">auto</span> trues = <span class="keyword">new</span> temp::Label*[<span class="number">2</span>];</span><br><span class="line">    <span class="keyword">auto</span> falses = <span class="keyword">new</span> temp::Label*[<span class="number">2</span>];</span><br><span class="line">    trues[<span class="number">0</span>] = stm-&gt;true_label_; trues[<span class="number">1</span>] = <span class="literal">nullptr</span>;</span><br><span class="line">    falses[<span class="number">0</span>] = stm-&gt;false_label_; falses[<span class="number">1</span>] = <span class="literal">nullptr</span>;</span><br><span class="line">    exp = <span class="keyword">new</span> tr::<span class="built_in">CxExp</span>(trues, falses, stm);</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​    其实就是一个CxExp的构造，我们需要把true_label和false_label的地址传入，以便之后回填。</p>
<h2 id="Part2-Tree-Language翻译成Assem"><a href="#Part2-Tree-Language翻译成Assem" class="headerlink" title="Part2 Tree Language翻译成Assem"></a>Part2 Tree Language翻译成Assem</h2><h3 id="基本数据结构"><a href="#基本数据结构" class="headerlink" title="基本数据结构"></a>基本数据结构</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Frame</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    temp::Label *label;</span><br><span class="line">    std::list&lt;Access*&gt; formals;</span><br><span class="line">    <span class="keyword">int</span> s_offset;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">Frame</span>() &#123;&#125;;</span><br><span class="line">    <span class="built_in">Frame</span>(temp::Label *name, std::list&lt;<span class="keyword">bool</span>&gt; *escapes) : <span class="built_in">label</span>(name) &#123;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> frame::Access *<span class="title">allocLocal</span><span class="params">(<span class="keyword">bool</span> escape)</span> </span>= <span class="number">0</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>​    Frame主要是存放函数的名字、寄存器的escape信息、以及栈上的分配offset。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">X64RegManager</span> :</span> <span class="keyword">public</span> RegManager &#123;</span><br><span class="line"><span class="keyword">public</span> :</span><br><span class="line">    <span class="built_in">X64RegManager</span>() &#123;</span><br><span class="line">		……</span><br><span class="line">        caller_saved_regiters = <span class="keyword">new</span> temp::<span class="built_in">TempList</span>(&#123;rax, rdi, rsi, rdx, rcx, r8, r9, r10, r11&#125;);</span><br><span class="line">        callee_saved_registers = <span class="keyword">new</span> temp::<span class="built_in">TempList</span>(&#123;rbx, rbp, r12, r13, r14, r15&#125;);</span><br><span class="line">        registers = <span class="keyword">new</span> temp::<span class="built_in">TempList</span>(&#123;rax, rdi, rsi, rdx, rcx, r8, r9, r10, r11, rbx, rbp, r12, r13, r14, r15, fp, rsp&#125;);</span><br><span class="line">        args_registers = <span class="keyword">new</span> temp::<span class="built_in">TempList</span>(&#123;rdi, rsi, rdx, rcx, r8, r9&#125;);</span><br><span class="line">        ret_sink_registers = <span class="keyword">new</span> temp::<span class="built_in">TempList</span>(&#123;rsp, rax, rbx, rbp, r12, r13, r14, r15&#125;);</span><br><span class="line">        allregs_noRSP = <span class="keyword">new</span> temp::<span class="built_in">TempList</span>(&#123;rax, rdi, rsi, rdx, rcx, r8, r9, r10, r11, rbx, rbp, r12, r13, r14, r15, fp&#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//caller-saved registers</span></span><br><span class="line">    temp::Temp *rax, *rdi, *rsi, *rdx, *rcx, *r8, *r9, *r10, *r11;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//callee-saved registers</span></span><br><span class="line">    temp::Temp *rbx, *rbp, *r12, *r13, *r14, *r15;</span><br><span class="line"></span><br><span class="line">    temp::Temp *fp;</span><br><span class="line">    temp::Temp *rsp;</span><br><span class="line"></span><br><span class="line">    temp::TempList *caller_saved_regiters, *callee_saved_registers, *registers, *args_registers, *ret_sink_registers, *allregs_noRSP;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="其他情况"><a href="#其他情况" class="headerlink" title="其他情况"></a>其他情况</h2><p>​    其他情况不再赘述，详见之后公开的Github仓库。</p>
<h3 id="ProcEntryExit1"><a href="#ProcEntryExit1" class="headerlink" title="ProcEntryExit1"></a>ProcEntryExit1</h3><p>​    主要是用来做view shift的，也就是把传入的寄存器参数存放到函数内来看它的位置。强调我的实现只是完成了功能，并没有性能上的考虑。所以，考虑到多个参数的情况，我先把所有传入的寄存器上的值和6个参数以外的栈上的值全部移到临时寄存器中，再重新根据我们的需要安排到栈上，此处的多余move应当是不必要的。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">tree::Stm *<span class="title">procEntryExit1</span><span class="params">(frame::Frame *frame, tree::Stm *stm)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> num = <span class="number">1</span>;</span><br><span class="line">    tree::Stm *viewshift = <span class="keyword">new</span> tree::<span class="built_in">ExpStm</span>(<span class="keyword">new</span> tree::<span class="built_in">ConstExp</span>(<span class="number">0</span>));</span><br><span class="line">    <span class="keyword">int</span> total_size = frame-&gt;formals.<span class="built_in">size</span>();</span><br><span class="line">    std::vector&lt;temp::Temp *&gt; tempList;</span><br><span class="line">    <span class="keyword">for</span> (frame::Access *formal : frame-&gt;formals) &#123;</span><br><span class="line">        temp::Temp *reg = temp::TempFactory::<span class="built_in">NewTemp</span>();</span><br><span class="line">        <span class="keyword">if</span> (num &lt;= <span class="number">6</span>) &#123;</span><br><span class="line">            viewshift = <span class="keyword">new</span> tree::<span class="built_in">SeqStm</span>(viewshift, <span class="keyword">new</span> tree::<span class="built_in">MoveStm</span>(<span class="keyword">new</span> tree::<span class="built_in">TempExp</span>(reg), <span class="keyword">new</span> tree::<span class="built_in">TempExp</span>(reg_manager-&gt;<span class="built_in">ARG_nth</span>(num))));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            viewshift = <span class="keyword">new</span> tree::<span class="built_in">SeqStm</span>(viewshift, <span class="keyword">new</span> tree::<span class="built_in">MoveStm</span>(<span class="keyword">new</span> tree::<span class="built_in">TempExp</span>(reg), tree::<span class="built_in">NewMemPlus_Const</span>(<span class="keyword">new</span> tree::<span class="built_in">TempExp</span>(reg_manager-&gt;<span class="built_in">FramePointer</span>()), <span class="number">-1</span> * (num - <span class="number">6</span>) * reg_manager-&gt;<span class="built_in">WordSize</span>())));</span><br><span class="line">        &#125;</span><br><span class="line">        tempList.<span class="built_in">push_back</span>(reg);</span><br><span class="line">        num++;</span><br><span class="line">    &#125;</span><br><span class="line">    num = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">for</span> (frame::Access *formal : frame-&gt;formals) &#123;</span><br><span class="line">        viewshift = <span class="keyword">new</span> tree::<span class="built_in">SeqStm</span>(viewshift, <span class="keyword">new</span> tree::<span class="built_in">MoveStm</span>(formal-&gt;<span class="built_in">ToExp</span>(<span class="keyword">new</span> tree::<span class="built_in">TempExp</span>(reg_manager-&gt;<span class="built_in">FramePointer</span>())), <span class="keyword">new</span> tree::<span class="built_in">TempExp</span>(tempList[num - <span class="number">1</span>])));</span><br><span class="line">        num++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> tree::<span class="built_in">SeqStm</span>(viewshift, stm);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="ProcEntryExit2"><a href="#ProcEntryExit2" class="headerlink" title="ProcEntryExit2"></a>ProcEntryExit2</h3><p>​    ProcEntryExit2是要在翻译完的body instruction后添加一条空指令，告诉我们函数结束的时候哪些寄存器是要被用到的。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">assem::InstrList *<span class="title">procEntryExit2</span><span class="params">(assem::InstrList *body)</span> </span>&#123;</span><br><span class="line">    temp::TempList *returnSink = reg_manager-&gt;<span class="built_in">ReturnSink</span>();</span><br><span class="line">    body-&gt;<span class="built_in">Append</span>(<span class="keyword">new</span> assem::<span class="built_in">OperInstr</span>(<span class="string">&quot;&quot;</span>, <span class="literal">nullptr</span>, returnSink, <span class="literal">nullptr</span>));</span><br><span class="line">    <span class="keyword">return</span> body;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="ProcEntryExit3"><a href="#ProcEntryExit3" class="headerlink" title="ProcEntryExit3"></a>ProcEntryExit3</h3><p>​    ProcEntryExit3生成过程入口处理和出口处理的汇编语言代码，主要是对栈指针的更改，以及设置framesize变量。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">assem::Proc *<span class="title">procEntryExit3</span><span class="params">(frame::Frame *frame, assem::InstrList * body)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">char</span> instr[<span class="number">256</span>];</span><br><span class="line"></span><br><span class="line">    std::string prolog;</span><br><span class="line">    <span class="keyword">int</span> size = -frame-&gt;s_offset - <span class="number">8</span>;</span><br><span class="line">    <span class="built_in">sprintf</span>(instr, <span class="string">&quot;.set %s_framesize, %d\n&quot;</span>, frame-&gt;label-&gt;<span class="built_in">Name</span>().<span class="built_in">c_str</span>(), size);</span><br><span class="line">    prolog = std::<span class="built_in">string</span>(instr);</span><br><span class="line">    <span class="built_in">sprintf</span>(instr, <span class="string">&quot;%s:\n&quot;</span>, frame-&gt;label-&gt;<span class="built_in">Name</span>().<span class="built_in">c_str</span>());</span><br><span class="line">    prolog.<span class="built_in">append</span>(std::<span class="built_in">string</span>(instr));</span><br><span class="line">    <span class="built_in">sprintf</span>(instr, <span class="string">&quot;subq $%d, %%rsp\n&quot;</span>, size);</span><br><span class="line">    prolog.<span class="built_in">append</span>(std::<span class="built_in">string</span>(instr));</span><br><span class="line"></span><br><span class="line">    <span class="built_in">sprintf</span>(instr, <span class="string">&quot;addq $%d, %%rsp\n&quot;</span>, size);</span><br><span class="line">    std::string epilog = std::<span class="built_in">string</span>(instr);</span><br><span class="line">    epilog.<span class="built_in">append</span>(std::<span class="built_in">string</span>(<span class="string">&quot;retq\n&quot;</span>));</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> assem::<span class="built_in">Proc</span>(prolog, body, epilog);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="处理传入大于6个参数的函数调用的情况"><a href="#处理传入大于6个参数的函数调用的情况" class="headerlink" title="处理传入大于6个参数的函数调用的情况"></a>处理传入大于6个参数的函数调用的情况</h3><p>首先，我们在tigermain中存在一个返回值-1，所以当我们主程序结束后，会根据这个-1跳转到run函数的循环。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># interpreter.py</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">run</span>(<span class="params">self</span>):</span></span><br><span class="line">    pc = self._state_table.get_pc()</span><br><span class="line">    <span class="keyword">while</span> pc &gt;= <span class="number">0</span>:</span><br><span class="line">        self._instructions[pc].execute(self._state_table)</span><br><span class="line">        pc = self._state_table.get_pc()</span><br></pre></td></tr></table></figure>

<p>​    如下图所示，我们目前创造了A的栈帧，并且把传入的参数都根据其是否逃逸放到了对应的寄存器和栈上。</p>
<img src="/2021/12/14/complier-lab5/image-20211214171419591.png" style="zoom: 80%;">

<p>​    我们假设此时A希望调用函数B，并且需要传入8个参数+1个static link，由于传参寄存器只有6个，所以后两个参数（记作23和45）和static link都需要放在栈上。</p>
<img src="/2021/12/14/complier-lab5/image-20211214181041023.png" style="zoom:80%;">

<p>​    注意此时，在%rsp-8处我们需要填充一个空的八字节，然后再依次放入23,45和static link。上图为call(B)前的栈上状态。</p>
<img src="/2021/12/14/complier-lab5/image-20211214181331975.png" style="zoom:80%;">

<p>​    在call(B)后，解释器会帮我们填入A的返回地址pc的位置，所以这八个字节是要空出来的，如上图所示。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># state_table.py</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">call</span>(<span class="params">self, label</span>):</span></span><br><span class="line">	<span class="comment"># print(self._reg_table)</span></span><br><span class="line">	label = label.replace(<span class="string">&#x27;@PLT&#x27;</span>, <span class="string">&#x27;&#x27;</span>)</span><br><span class="line">	<span class="keyword">if</span> label <span class="keyword">in</span> self._label_table:</span><br><span class="line">		self._func_name_stack.append(self._current_func)</span><br><span class="line">		self._current_func = label</span><br><span class="line">		rsp = self.load_reg(<span class="string">&#x27;%rsp&#x27;</span>) - <span class="number">8</span></span><br><span class="line">		self.store_mem(rsp, self._pc)</span><br><span class="line">		self.store_reg(<span class="string">&#x27;%rsp&#x27;</span>, rsp)</span><br><span class="line">		self._pc = self._label_table[label]</span><br><span class="line">		self._func_temp_stack.append(self._temp_table.copy())</span><br><span class="line">		self._temp_table.clear()</span><br></pre></td></tr></table></figure>

<p>​    如下图所示，这是我们调用call(B)瞬间，还没有对传入参数做寄存器和栈分配时，栈上的情况。</p>
<img src="/2021/12/14/complier-lab5/image-20211214181606771.png" style="zoom:80%;">

<p>​    接下来，我们继续对寄存器做escape allocation，最终得到一个完整的B运行时栈。</p>
<img src="/2021/12/14/complier-lab5/image-20211214181944801.png" style="zoom:80%;">

<p>​    故代码如下：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">temp::TempList *<span class="title">ExpList::MunchArgs</span><span class="params">(assem::InstrList &amp;instr_list, std::string_view fs)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">auto</span> tempList = <span class="keyword">new</span> temp::<span class="built_in">TempList</span>();</span><br><span class="line">    <span class="keyword">int</span> num = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">int</span> out_formal = exp_list_.<span class="built_in">size</span>() - <span class="number">6</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (out_formal &gt; <span class="number">0</span>)</span><br><span class="line">        instr_list.<span class="built_in">Append</span>(<span class="keyword">new</span> assem::<span class="built_in">OperInstr</span>(<span class="string">&quot;subq $&quot;</span> + std::<span class="built_in">to_string</span>(reg_manager-&gt;<span class="built_in">WordSize</span>()) + <span class="string">&quot;,%rsp&quot;</span>,</span><br><span class="line">                                               <span class="literal">nullptr</span>, <span class="literal">nullptr</span>, <span class="literal">nullptr</span>));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (tree::Exp *exp : exp_list_) &#123;</span><br><span class="line">        temp::Temp *arg = exp-&gt;<span class="built_in">Munch</span>(instr_list, fs);</span><br><span class="line">        tempList-&gt;<span class="built_in">Append</span>(arg);</span><br><span class="line">        <span class="keyword">if</span> (reg_manager-&gt;<span class="built_in">ARG_nth</span>(num)) &#123;</span><br><span class="line">            instr_list.<span class="built_in">Append</span>(<span class="keyword">new</span> assem::<span class="built_in">MoveInstr</span>(<span class="string">&quot;movq `s0, `d0&quot;</span>, <span class="keyword">new</span> temp::<span class="built_in">TempList</span>(reg_manager-&gt;<span class="built_in">ARG_nth</span>(num)), <span class="keyword">new</span> temp::<span class="built_in">TempList</span>(arg)));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            instr_list.<span class="built_in">Append</span>(<span class="keyword">new</span> assem::<span class="built_in">OperInstr</span>(<span class="string">&quot;subq $&quot;</span> + std::<span class="built_in">to_string</span>(reg_manager-&gt;<span class="built_in">WordSize</span>()) + <span class="string">&quot;,%rsp&quot;</span>,<span class="literal">nullptr</span>, <span class="literal">nullptr</span>, <span class="literal">nullptr</span>));</span><br><span class="line">            instr_list.<span class="built_in">Append</span>(<span class="keyword">new</span> assem::<span class="built_in">MoveInstr</span>(<span class="string">&quot;movq `s0, (`d0)&quot;</span>, <span class="keyword">new</span> temp::<span class="built_in">TempList</span>(reg_manager-&gt;<span class="built_in">StackPointer</span>()), <span class="keyword">new</span> temp::<span class="built_in">TempList</span>(arg)));</span><br><span class="line">        &#125;</span><br><span class="line">        num++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (out_formal &gt; <span class="number">0</span>)</span><br><span class="line">        instr_list.<span class="built_in">Append</span>(<span class="keyword">new</span> assem::<span class="built_in">OperInstr</span>(<span class="string">&quot;addq $&quot;</span> + std::<span class="built_in">to_string</span>(reg_manager-&gt;<span class="built_in">WordSize</span>() * (out_formal + <span class="number">1</span>)) + <span class="string">&quot;,%rsp&quot;</span>,<span class="literal">nullptr</span>, <span class="literal">nullptr</span>, <span class="literal">nullptr</span>));</span><br><span class="line">    <span class="keyword">return</span> tempList;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</div><div class="article-licensing box"><div class="licensing-title"><p>complier-lab5</p><p><a href="https://kami-code.com/2021/12/14/complier-lab5/">https://kami-code.com/2021/12/14/complier-lab5/</a></p></div><div class="licensing-meta level is-mobile"><div class="level-left"><div class="level-item is-narrow"><div><h6>Author</h6><p>Kami-code</p></div></div><div class="level-item is-narrow"><div><h6>Posted on</h6><p>2021-12-14</p></div></div><div class="level-item is-narrow"><div><h6>Updated on</h6><p>2021-12-26</p></div></div><div class="level-item is-narrow"><div><h6>Licensed under</h6><p><a class="icons" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="icon fab fa-creative-commons"></i></a><a class="icons" rel="noopener" target="_blank" title="Attribution" href="https://creativecommons.org/licenses/by/4.0/"><i class="icon fab fa-creative-commons-by"></i></a><a class="icons" rel="noopener" target="_blank" title="Noncommercial" href="https://creativecommons.org/licenses/by-nc/4.0/"><i class="icon fab fa-creative-commons-nc"></i></a></p></div></div></div></div></div><div class="article-tags is-size-7 mb-4"><span class="mr-2">#</span><a class="link-muted mr-2" rel="tag" href="/tags/lab/">lab</a><a class="link-muted mr-2" rel="tag" href="/tags/compliers/">compliers</a></div><!--!--></article></div><!--!--><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/2021/12/18/SE3353-assignment10/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">SE3353-assignment10</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2021/12/09/CHOMP-and-related-works/"><span class="level-item">CHOMP_and_related_works</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><div class="card"><div class="card-content"><h3 class="title is-5">Comments</h3><div id="SOHUCS" sid="2021/12/14/complier-lab5/"></div><script charset="utf-8" src="https://changyan.sohu.com/upload/changyan.js"></script><script>window.changyan.api.config({appid: 'cyvI88c19',conf: 'prod_634561f1ec380218934dcf2c12b8b70b'});</script></div></div></div><div class="column column-left is-4-tablet is-4-desktop is-4-widescreen  order-1"><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar" src="/img/avatar.jpg" alt="Chen Bao"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">Chen Bao</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>Shanghai, China</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">Posts</p><a href="/archives"><p class="title">24</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Categories</p><a href="/categories"><p class="title">0</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Tags</p><a href="/tags"><p class="title">34</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://github.com/Kami-code" target="_blank" rel="noopener">Follow</a></div><div class="level is-mobile is-multiline"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/Kami-code"><i class="fab fa-github"></i></a></div></div></div><!--!--><div class="card widget" data-type="links"><div class="card-content"><div class="menu"><h3 class="menu-label">Links</h3><ul class="menu-list"><li><a class="level is-mobile" href="https://hexo.io" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Hexo</span></span><span class="level-right"><span class="level-item tag">hexo.io</span></span></a></li><li><a class="level is-mobile" href="https://bulma.io" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Bulma</span></span><span class="level-right"><span class="level-item tag">bulma.io</span></span></a></li></ul></div></div></div><!--!--><div class="card widget" data-type="recent-posts"><div class="card-content"><h3 class="menu-label">Recents</h3><article class="media"><div class="media-content"><p class="date"><time dateTime="2022-01-29T03:41:38.000Z">2022-01-29</time></p><p class="title"><a href="/2022/01/29/unigrasp/">unigrasp</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2022-01-26T10:59:39.000Z">2022-01-26</time></p><p class="title"><a href="/2022/01/26/GIGA/">(RSS2021)GIGA</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2022-01-18T06:33:35.000Z">2022-01-18</time></p><p class="title"><a href="/2022/01/18/GraspNet-1Billion/">(CVPR2020)GraspNet-1Billion</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2022-01-17T07:07:22.000Z">2022-01-17</time></p><p class="title"><a href="/2022/01/17/6D-GraspNet/">(ICCV2019)6D-GraspNet</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2022-01-17T06:39:59.000Z">2022-01-17</time></p><p class="title"><a href="/2022/01/17/machine-learning-pre/">VoteNet_pre</a></p></div></article></div></div><div class="card widget" data-type="archives"><div class="card-content"><div class="menu"><h3 class="menu-label">Archives</h3><ul class="menu-list"><li><a class="level is-mobile" href="/archives/2022/01/"><span class="level-start"><span class="level-item">January 2022</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/12/"><span class="level-start"><span class="level-item">December 2021</span></span><span class="level-end"><span class="level-item tag">6</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/11/"><span class="level-start"><span class="level-item">November 2021</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/10/"><span class="level-start"><span class="level-item">October 2021</span></span><span class="level-end"><span class="level-item tag">8</span></span></a></li></ul></div></div></div><div class="card widget" data-type="tags"><div class="card-content"><div class="menu"><h3 class="menu-label">Tags</h3><div class="field is-grouped is-grouped-multiline"><div class="control"><a class="tags has-addons" href="/tags/6D-GraspNet/"><span class="tag">6D-GraspNet</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/CHOMP/"><span class="tag">CHOMP</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/CVPR/"><span class="tag">CVPR</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Camera/"><span class="tag">Camera</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Docker/"><span class="tag">Docker</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/GraspNet/"><span class="tag">GraspNet</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ICCV/"><span class="tag">ICCV</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ICRA/"><span class="tag">ICRA</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/MongoDB/"><span class="tag">MongoDB</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/MySQL/"><span class="tag">MySQL</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Neo4j/"><span class="tag">Neo4j</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/OpenCV/"><span class="tag">OpenCV</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/OpenGL/"><span class="tag">OpenGL</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/PointNet/"><span class="tag">PointNet</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/PointNet/"><span class="tag">PointNet++</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Pybind11/"><span class="tag">Pybind11</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Pybullet/"><span class="tag">Pybullet</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ROS/"><span class="tag">ROS</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/RSS/"><span class="tag">RSS</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/SE3353/"><span class="tag">SE3353</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ScrewNet/"><span class="tag">ScrewNet</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Search/"><span class="tag">Search</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/VoteNet/"><span class="tag">VoteNet</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/WebService/"><span class="tag">WebService</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/behavior-tree/"><span class="tag">behavior tree</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/compliers/"><span class="tag">compliers</span><span class="tag">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/deeplearning/"><span class="tag">deeplearning</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ikfast/"><span class="tag">ikfast</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/lab/"><span class="tag">lab</span><span class="tag">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/mmdection/"><span class="tag">mmdection</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/moveit/"><span class="tag">moveit</span><span class="tag">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/planning/"><span class="tag">planning</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/pybullet/"><span class="tag">pybullet</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/segmentation/"><span class="tag">segmentation</span><span class="tag">1</span></a></div></div></div></div></div><div class="card widget" data-type="subscribe-email"><div class="card-content"><div class="menu"><h3 class="menu-label">Subscribe for updates</h3><form action="https://feedburner.google.com/fb/a/mailverify" method="post" target="popupwindow" onsubmit="window.open(&#039;https://feedburner.google.com/fb/a/mailverify?uri=&#039;,&#039;popupwindow&#039;,&#039;scrollbars=yes,width=550,height=520&#039;);return true"><input type="hidden" value="" name="uri"><input type="hidden" name="loc" value="en_US"><div class="field has-addons"><div class="control has-icons-left is-expanded"><input class="input" name="email" type="email" placeholder="Email"><span class="icon is-small is-left"><i class="fas fa-envelope"></i></span></div><div class="control"><input class="button" type="submit" value="Subscribe"></div></div></form></div></div></div><div class="card widget" data-type="subscribe-email"><div class="card-content"><div class="menu"><h3 class="menu-label">follow.it</h3><form action="" method="post" target="_blank"><div class="field has-addons"><div class="control has-icons-left is-expanded"><input class="input" name="email" type="email" placeholder="Email"><span class="icon is-small is-left"><i class="fas fa-envelope"></i></span></div><div class="control"><input class="button" type="submit" value="Subscribe"></div></div></form></div></div></div></div><!--!--></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/logo.svg" alt="Ryan &#039;s website" height="28"></a><span id="busuanzi_container_site_pv">本站总访问量<span id="busuanzi_value_site_pv"></span>次</span><span class="post-meta-divider">|</span><span id="busuanzi_container_site_uv" style="display:none">本站访客数<span id="busuanzi_value_site_uv"></span>人</span><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><p class="is-size-7"><span>&copy; 2022 Kami-code</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("en");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="Back to top" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "This website uses cookies to improve your experience.",
          dismiss: "Got it!",
          allow: "Allow cookies",
          deny: "Decline",
          link: "Learn more",
          policy: "Cookie Policy",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><script type="text/x-mathjax-config">MathJax.Hub.Config({
            'HTML-CSS': {
                matchFontHeight: false
            },
            SVG: {
                matchFontHeight: false
            },
            CommonHTML: {
                matchFontHeight: false
            },
            tex2jax: {
                inlineMath: [
                    ['$','$'],
                    ['\\(','\\)']
                ]
            }
        });</script><script src="https://cdn.jsdelivr.net/npm/mathjax@2.7.5/unpacked/MathJax.js?config=TeX-MML-AM_CHTML" defer></script><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="Type something..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"Type something...","untitled":"(Untitled)","posts":"Posts","pages":"Pages","categories":"Categories","tags":"Tags"});
        });</script></body></html>