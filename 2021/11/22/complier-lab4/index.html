<!doctype html>
<html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>complier-lab4 - Ryan &#039;s website</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="Ryan&#039;s blog"><meta name="msapplication-TileImage" content="/img/favicon.svg"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="Ryan&#039;s blog"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="This lab comes from SE3355 *Compilers*  lab4, which requires me to implement a type-checking module when scanning the AST."><meta property="og:type" content="blog"><meta property="og:title" content="complier-lab4"><meta property="og:url" content="https://kami-code.com/2021/11/22/complier-lab4/"><meta property="og:site_name" content="Ryan &#039;s website"><meta property="og:description" content="This lab comes from SE3355 *Compilers*  lab4, which requires me to implement a type-checking module when scanning the AST."><meta property="og:locale" content="en_US"><meta property="og:image" content="https://kami-code.com/img/og_image.png"><meta property="article:published_time" content="2021-11-22T13:31:57.000Z"><meta property="article:modified_time" content="2021-11-22T13:34:53.607Z"><meta property="article:author" content="Kami-code"><meta property="article:tag" content="lab"><meta property="article:tag" content="compliers"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="/img/og_image.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://kami-code.com/2021/11/22/complier-lab4/"},"headline":"complier-lab4","image":["https://kami-code.com/img/og_image.png"],"datePublished":"2021-11-22T13:31:57.000Z","dateModified":"2021-11-22T13:34:53.607Z","author":{"@type":"Person","name":"Kami-code"},"publisher":{"@type":"Organization","name":"Ryan 's website","logo":{"@type":"ImageObject","url":"https://kami-code.com/img/logo.svg"}},"description":"This lab comes from SE3355 *Compilers*  lab4, which requires me to implement a type-checking module when scanning the AST."}</script><link rel="canonical" href="https://kami-code.com/2021/11/22/complier-lab4/"><link rel="icon" href="/img/favicon.svg"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.2/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/css/justifiedGallery.min.css"><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script><!--!--><!--!--><meta name="generator" content="Hexo 5.4.0"></head><body class="is-2-column"><nav class="navbar navbar-main"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/logo.svg" alt="Ryan &#039;s website" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a><a class="navbar-item" href="/about">About</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus"><i class="fab fa-github"></i></a><a class="navbar-item search" title="Search" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-8-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2021-11-22T13:31:57.000Z" title="2021/11/22 下午9:31:57">2021-11-22</time></span><span class="level-item">Updated&nbsp;<time dateTime="2021-11-22T13:34:53.607Z" title="2021/11/22 下午9:34:53">2021-11-22</time></span><span class="level-item">12 minutes read (About 1759 words)</span></div></div><h1 class="title is-3 is-size-4-mobile">complier-lab4</h1><div class="content"><p>This lab comes from SE3355 *<strong>Compilers*</strong>  lab4, which requires me to implement a type-checking module when scanning the AST. </p>
<span id="more"></span>

<p>The AST is created by bisonc++ script implemented in <a target="_blank" rel="noopener" href="https://www.kami-code.com/2021/11/04/complier-lab3/">lab3</a>. To make the following statement more clear, we can take a see of the structure of the AST node. The venv contains the symbols of variables and functions and the tenv contains the symbols of all types. </p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Var</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">  <span class="keyword">int</span> pos_;</span><br><span class="line">  <span class="keyword">virtual</span> ~<span class="built_in">Var</span>() = <span class="keyword">default</span>;</span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">Print</span><span class="params">(FILE *out, <span class="keyword">int</span> d)</span> <span class="keyword">const</span> </span>= <span class="number">0</span>;</span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> type::Ty *<span class="title">SemAnalyze</span><span class="params">(env::VEnvPtr venv, env::TEnvPtr tenv,</span></span></span><br><span class="line"><span class="params"><span class="function">                               <span class="keyword">int</span> labelcount,</span></span></span><br><span class="line"><span class="params"><span class="function">                               err::ErrorMsg *errormsg)</span> <span class="keyword">const</span> </span>= <span class="number">0</span>;</span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">  <span class="function"><span class="keyword">explicit</span> <span class="title">Var</span><span class="params">(<span class="keyword">int</span> pos)</span> : pos_(pos) &#123;</span>&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Exp</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">  <span class="keyword">int</span> pos_;</span><br><span class="line">  <span class="keyword">virtual</span> ~<span class="built_in">Exp</span>() = <span class="keyword">default</span>;</span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">Print</span><span class="params">(FILE *out, <span class="keyword">int</span> d)</span> <span class="keyword">const</span> </span>= <span class="number">0</span>;</span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> type::Ty *<span class="title">SemAnalyze</span><span class="params">(env::VEnvPtr venv, env::TEnvPtr tenv,</span></span></span><br><span class="line"><span class="params"><span class="function">                               <span class="keyword">int</span> labelcount,</span></span></span><br><span class="line"><span class="params"><span class="function">                               err::ErrorMsg *errormsg)</span> <span class="keyword">const</span> </span>= <span class="number">0</span>;</span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">  <span class="function"><span class="keyword">explicit</span> <span class="title">Exp</span><span class="params">(<span class="keyword">int</span> pos)</span> : pos_(pos) &#123;</span>&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Dec</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">  <span class="keyword">int</span> pos_;</span><br><span class="line">  <span class="keyword">virtual</span> ~<span class="built_in">Dec</span>() = <span class="keyword">default</span>;</span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">Print</span><span class="params">(FILE *out, <span class="keyword">int</span> d)</span> <span class="keyword">const</span> </span>= <span class="number">0</span>;</span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">SemAnalyze</span><span class="params">(env::VEnvPtr venv, env::TEnvPtr tenv, <span class="keyword">int</span> labelcount,</span></span></span><br><span class="line"><span class="params"><span class="function">                          err::ErrorMsg *errormsg)</span> <span class="keyword">const</span> </span>= <span class="number">0</span>;</span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">  <span class="function"><span class="keyword">explicit</span> <span class="title">Dec</span><span class="params">(<span class="keyword">int</span> pos)</span> : pos_(pos) &#123;</span>&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Ty</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">  <span class="keyword">int</span> pos_;</span><br><span class="line">  <span class="keyword">virtual</span> ~<span class="built_in">Ty</span>() = <span class="keyword">default</span>;</span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">Print</span><span class="params">(FILE *out, <span class="keyword">int</span> d)</span> <span class="keyword">const</span> </span>= <span class="number">0</span>;</span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> type::Ty *<span class="title">SemAnalyze</span><span class="params">(env::TEnvPtr tenv,</span></span></span><br><span class="line"><span class="params"><span class="function">                               err::ErrorMsg *errormsg)</span> <span class="keyword">const</span> </span>= <span class="number">0</span>;</span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">  <span class="function"><span class="keyword">explicit</span> <span class="title">Ty</span><span class="params">(<span class="keyword">int</span> pos)</span> : pos_(pos) &#123;</span>&#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>



<h2 id="Part-1-Some-Basic-Type-Checking"><a href="#Part-1-Some-Basic-Type-Checking" class="headerlink" title="Part 1 Some Basic Type Checking"></a>Part 1 Some Basic Type Checking</h2><h3 id="1-1-some-root-and-leaves"><a href="#1-1-some-root-and-leaves" class="headerlink" title="1.1 some root and leaves"></a>1.1 some root and leaves</h3><p>We want to get the type of every variable, expression and declaration, so we can easily do it from the root and leaves.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">AbsynTree::SemAnalyze</span><span class="params">(env::VEnvPtr venv, env::TEnvPtr tenv,</span></span></span><br><span class="line"><span class="params"><span class="function">    err::ErrorMsg *errormsg)</span> <span class="keyword">const</span> </span>&#123;</span><br><span class="line">    root_-&gt;<span class="built_in">SemAnalyze</span>(venv, tenv, <span class="number">0</span>, errormsg);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">type::Ty *<span class="title">VarExp::SemAnalyze</span><span class="params">(env::VEnvPtr venv, env::TEnvPtr tenv,</span></span></span><br><span class="line"><span class="params"><span class="function">                             <span class="keyword">int</span> labelcount, err::ErrorMsg *errormsg)</span> <span class="keyword">const</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> var_-&gt;<span class="built_in">SemAnalyze</span>(venv, tenv, labelcount, errormsg);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">type::Ty *<span class="title">NilExp::SemAnalyze</span><span class="params">(env::VEnvPtr venv, env::TEnvPtr tenv,</span></span></span><br><span class="line"><span class="params"><span class="function">                             <span class="keyword">int</span> labelcount, err::ErrorMsg *errormsg)</span> <span class="keyword">const</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> type::NilTy::<span class="built_in">Instance</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">type::Ty *<span class="title">IntExp::SemAnalyze</span><span class="params">(env::VEnvPtr venv, env::TEnvPtr tenv,</span></span></span><br><span class="line"><span class="params"><span class="function">                             <span class="keyword">int</span> labelcount, err::ErrorMsg *errormsg)</span> <span class="keyword">const</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> type::IntTy::<span class="built_in">Instance</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">type::Ty *<span class="title">StringExp::SemAnalyze</span><span class="params">(env::VEnvPtr venv, env::TEnvPtr tenv,  <span class="keyword">int</span> labelcount, err::ErrorMsg *errormsg)</span> <span class="keyword">const</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> type::StringTy::<span class="built_in">Instance</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">type::Ty *<span class="title">VoidExp::SemAnalyze</span><span class="params">(env::VEnvPtr venv, env::TEnvPtr tenv,</span></span></span><br><span class="line"><span class="params"><span class="function">                              <span class="keyword">int</span> labelcount, err::ErrorMsg *errormsg)</span> <span class="keyword">const</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> type::VoidTy::<span class="built_in">Instance</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="1-2-Variables"><a href="#1-2-Variables" class="headerlink" title="1.2 Variables"></a>1.2 Variables</h3><p>The type-checking code of three variables is as follows.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">type::Ty *<span class="title">SimpleVar::SemAnalyze</span><span class="params">(env::VEnvPtr venv, env::TEnvPtr tenv,</span></span></span><br><span class="line"><span class="params"><span class="function"><span class="keyword">int</span> labelcount, err::ErrorMsg *errormsg)</span> <span class="keyword">const</span> </span>&#123;</span><br><span class="line">	env::EnvEntry *entry = venv-&gt;<span class="built_in">Look</span>(sym_);</span><br><span class="line">	<span class="keyword">if</span> (entry &amp;&amp; (<span class="built_in"><span class="keyword">typeid</span></span>(*entry) == <span class="built_in"><span class="keyword">typeid</span></span>(env::VarEntry))) &#123;</span><br><span class="line">		env::VarEntry* varEntry = <span class="keyword">static_cast</span>&lt;env::VarEntry *&gt;(entry);</span><br><span class="line">		type::Ty *type = varEntry-&gt;ty_;</span><br><span class="line">		<span class="keyword">bool</span> readonly = varEntry-&gt;readonly_;</span><br><span class="line">		<span class="keyword">return</span> type;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> &#123;</span><br><span class="line">		errormsg-&gt;<span class="built_in">Error</span>(pos_, <span class="string">&quot;undefined variable %s&quot;</span>, sym_-&gt;<span class="built_in">Name</span>().<span class="built_in">data</span>());</span><br><span class="line">		&#125;</span><br><span class="line">	<span class="keyword">return</span> type::IntTy::<span class="built_in">Instance</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">type::Ty *<span class="title">FieldVar::SemAnalyze</span><span class="params">(env::VEnvPtr venv, env::TEnvPtr tenv,</span></span></span><br><span class="line"><span class="params"><span class="function"><span class="keyword">int</span> labelcount, err::ErrorMsg *errormsg)</span> <span class="keyword">const</span> </span>&#123;</span><br><span class="line">	<span class="comment">// for field var first check var need to be a RecordTy, then check the sym_ is in the recordTY type</span></span><br><span class="line">	type::Ty * variable_type = var_-&gt;<span class="built_in">SemAnalyze</span>(venv, tenv, labelcount, errormsg);</span><br><span class="line">	<span class="keyword">if</span> (variable_type == <span class="literal">nullptr</span>) &#123;</span><br><span class="line">		errormsg-&gt;<span class="built_in">Error</span>(pos_, <span class="string">&quot;variable not defined.&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in"><span class="keyword">typeid</span></span>(*(variable_type-&gt;<span class="built_in">ActualTy</span>())) != <span class="built_in"><span class="keyword">typeid</span></span>(type::RecordTy)) &#123;</span><br><span class="line">		errormsg-&gt;<span class="built_in">Error</span>(pos_, <span class="string">&quot;not a record type&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> &#123;</span><br><span class="line">		type::RecordTy * real_type = ((type::RecordTy *) (variable_type));</span><br><span class="line">		<span class="keyword">int</span> matched = <span class="number">0</span>;</span><br><span class="line">		<span class="keyword">for</span> (type::Field* field:real_type-&gt;fields_-&gt;<span class="built_in">GetList</span>()) &#123;</span><br><span class="line">			<span class="keyword">if</span> (field-&gt;name_-&gt;<span class="built_in">Name</span>() == sym_-&gt;<span class="built_in">Name</span>()) &#123;</span><br><span class="line">				matched = <span class="number">1</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (matched == <span class="number">1</span>) &#123;</span><br><span class="line">			<span class="keyword">return</span> real_type;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> &#123;</span><br><span class="line">			errormsg-&gt;<span class="built_in">Error</span>(pos_, <span class="string">&quot;field nam doesn&#x27;t exist&quot;</span>);</span><br><span class="line">			<span class="keyword">return</span> real_type;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">type::Ty *<span class="title">SubscriptVar::SemAnalyze</span><span class="params">(env::VEnvPtr venv, env::TEnvPtr tenv,</span></span></span><br><span class="line"><span class="params"><span class="function"><span class="keyword">int</span> labelcount, err::ErrorMsg *errormsg)</span> <span class="keyword">const</span> </span>&#123;</span><br><span class="line">	<span class="comment">//check the type of var_ is an array or not</span></span><br><span class="line">    <span class="comment">//if so, check subscript_ is an int or not, and check the range.</span></span><br><span class="line">	type::Ty *var_type = var_-&gt;<span class="built_in">SemAnalyze</span>(venv, tenv, labelcount, errormsg); </span><br><span class="line">    <span class="comment">//var_type is array of the type that we want to return</span></span><br><span class="line">    <span class="keyword">if</span> (var_type == <span class="literal">nullptr</span>) &#123;</span><br><span class="line">    	errormsg-&gt;<span class="built_in">Error</span>(pos_, <span class="string">&quot;variable not defined.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in"><span class="keyword">typeid</span></span>(*(var_type-&gt;<span class="built_in">ActualTy</span>())) != <span class="built_in"><span class="keyword">typeid</span></span>(type::ArrayTy)) &#123;</span><br><span class="line">    	errormsg-&gt;<span class="built_in">Error</span>(pos_, <span class="string">&quot;array type required&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">    	type::Ty *subscript_type = subscript_-&gt;<span class="built_in">SemAnalyze</span>(venv, tenv, labelcount, errormsg);</span><br><span class="line">    	<span class="keyword">if</span> (<span class="built_in"><span class="keyword">typeid</span></span>(*(subscript_type-&gt;<span class="built_in">ActualTy</span>())) != <span class="built_in"><span class="keyword">typeid</span></span>(type::IntTy)) &#123;</span><br><span class="line">    		errormsg-&gt;<span class="built_in">Error</span>(pos_, <span class="string">&quot;subscribe is not a int type.&quot;</span>);</span><br><span class="line">    	&#125;</span><br><span class="line">    	<span class="keyword">else</span> &#123;</span><br><span class="line">    		<span class="built_in"><span class="keyword">return</span></span> ((type::ArrayTy *) var_type)-&gt;ty_;</span><br><span class="line">    	&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="1-3-Call-expression"><a href="#1-3-Call-expression" class="headerlink" title="1.3 Call expression"></a>1.3 Call expression</h3><p>The type-checking code of call expression is as follows.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">type::Ty *<span class="title">CallExp::SemAnalyze</span><span class="params">(env::VEnvPtr venv, env::TEnvPtr tenv,</span></span></span><br><span class="line"><span class="params"><span class="function">                              <span class="keyword">int</span> labelcount, err::ErrorMsg *errormsg)</span> <span class="keyword">const</span> </span>&#123;</span><br><span class="line">    env::FunEntry *funEntry = <span class="keyword">static_cast</span>&lt;env::FunEntry *&gt;(venv-&gt;<span class="built_in">Look</span>(func_));</span><br><span class="line">    <span class="keyword">if</span> (funEntry == <span class="literal">nullptr</span>) &#123;</span><br><span class="line">        errormsg-&gt;<span class="built_in">Error</span>(pos_, <span class="string">&quot;undefined function &quot;</span> + func_-&gt;<span class="built_in">Name</span>());</span><br><span class="line">        <span class="keyword">return</span> type::NilTy::<span class="built_in">Instance</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    std::list&lt;Exp *&gt; args_list = args_-&gt;<span class="built_in">GetList</span>();</span><br><span class="line">    <span class="keyword">if</span> (funEntry-&gt;formals_ == <span class="literal">nullptr</span>) &#123;</span><br><span class="line">        <span class="keyword">auto</span> args_it = args_-&gt;<span class="built_in">GetList</span>().<span class="built_in">begin</span>();</span><br><span class="line">        <span class="keyword">for</span> (; args_it != args_-&gt;<span class="built_in">GetList</span>().<span class="built_in">end</span>(); args_it++) &#123;</span><br><span class="line">            Exp *current_exp = *args_it;</span><br><span class="line">            current_exp-&gt;<span class="built_in">SemAnalyze</span>(venv, tenv, labelcount, errormsg);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">auto</span> formal_it = funEntry-&gt;formals_-&gt;<span class="built_in">GetList</span>().<span class="built_in">begin</span>();</span><br><span class="line">        <span class="keyword">auto</span> args_it = args_-&gt;<span class="built_in">GetList</span>().<span class="built_in">begin</span>();</span><br><span class="line">        <span class="keyword">for</span> (; formal_it != funEntry-&gt;formals_-&gt;<span class="built_in">GetList</span>().<span class="built_in">end</span>() &amp;&amp; args_it != args_-&gt;<span class="built_in">GetList</span>().<span class="built_in">end</span>(); formal_it++, args_it++) &#123;</span><br><span class="line">            Exp *current_exp = *args_it;</span><br><span class="line">            type::Ty *formal_type = *formal_it;</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in"><span class="keyword">typeid</span></span>(*(current_exp-&gt;<span class="built_in">SemAnalyze</span>(venv, tenv, labelcount, errormsg)-&gt;<span class="built_in">ActualTy</span>())) != <span class="built_in"><span class="keyword">typeid</span></span>(*formal_type)) &#123;</span><br><span class="line">                <span class="comment">// type not match</span></span><br><span class="line">                errormsg-&gt;<span class="built_in">Error</span>(current_exp-&gt;pos_, <span class="string">&quot;para type mismatch&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (args_it != args_-&gt;<span class="built_in">GetList</span>().<span class="built_in">end</span>()) &#123;</span><br><span class="line">            <span class="comment">// number does not match</span></span><br><span class="line">            <span class="keyword">auto</span> last_it = args_-&gt;<span class="built_in">GetList</span>().<span class="built_in">end</span>();</span><br><span class="line">            last_it--;</span><br><span class="line">            errormsg-&gt;<span class="built_in">Error</span>((*last_it)-&gt;pos_, <span class="string">&quot;too many params in function g&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (formal_it != funEntry-&gt;formals_-&gt;<span class="built_in">GetList</span>().<span class="built_in">end</span>()) &#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (funEntry-&gt;result_ != <span class="literal">nullptr</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> funEntry-&gt;result_;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> type::NilTy::<span class="built_in">Instance</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Part-2-Some-Tricky-Part"><a href="#Part-2-Some-Tricky-Part" class="headerlink" title="Part 2 Some Tricky Part"></a>Part 2 Some Tricky Part</h2><h3 id="2-1-the-loop-variable-shouldn’t-be-assigned"><a href="#2-1-the-loop-variable-shouldn’t-be-assigned" class="headerlink" title="2.1 the loop variable shouldn’t be assigned"></a>2.1 the loop variable shouldn’t be assigned</h3><p>Since the loop variable in a for-loop can’t not be assigned because of the rule of the tiger language, when a for-loop declares a variable, the variable should be marked with “readonly = true”. In such way, when encountering a variable in assign exp, the module can check the variable is read-only or not.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">type::Ty *<span class="title">ForExp::SemAnalyze</span><span class="params">(env::VEnvPtr venv, env::TEnvPtr tenv,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">int</span> labelcount, err::ErrorMsg *errormsg)</span> <span class="keyword">const</span> </span>&#123;</span><br><span class="line">    venv-&gt;<span class="built_in">BeginScope</span>();</span><br><span class="line">    type::Ty *lo_type = lo_-&gt;<span class="built_in">SemAnalyze</span>(venv, tenv, labelcount, errormsg);</span><br><span class="line">    venv-&gt;<span class="built_in">Enter</span>(var_, <span class="keyword">new</span> env::<span class="built_in">VarEntry</span>(lo_type, <span class="literal">true</span>));</span><br><span class="line">    type::Ty *hi_type = hi_-&gt;<span class="built_in">SemAnalyze</span>(venv, tenv, labelcount, errormsg);</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in"><span class="keyword">typeid</span></span>(*(hi_type-&gt;<span class="built_in">ActualTy</span>())) != <span class="built_in"><span class="keyword">typeid</span></span>(type::IntTy)) &#123;</span><br><span class="line">    	errormsg-&gt;<span class="built_in">Error</span>(hi_-&gt;pos_, <span class="string">&quot;for exp&#x27;s range type is not integer&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    body_-&gt;<span class="built_in">SemAnalyze</span>(venv, tenv, labelcount + <span class="number">1</span>, errormsg);</span><br><span class="line">    venv-&gt;<span class="built_in">EndScope</span>();</span><br><span class="line">    <span class="keyword">return</span> type::NilTy::<span class="built_in">Instance</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">type::Ty *<span class="title">AssignExp::SemAnalyze</span><span class="params">(env::VEnvPtr venv, env::TEnvPtr tenv,</span></span></span><br><span class="line"><span class="params"><span class="function">                                <span class="keyword">int</span> labelcount, err::ErrorMsg *errormsg)</span> <span class="keyword">const</span> </span>&#123;</span><br><span class="line">    type::Ty *var_type = var_-&gt;<span class="built_in">SemAnalyze</span>(venv, tenv, labelcount, errormsg);</span><br><span class="line">    type::Ty *exp_type = exp_-&gt;<span class="built_in">SemAnalyze</span>(venv, tenv, labelcount, errormsg);</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in"><span class="keyword">typeid</span></span>(*(exp_type-&gt;<span class="built_in">ActualTy</span>())) == <span class="built_in"><span class="keyword">typeid</span></span>(type::NilTy) &amp;&amp; <span class="built_in"><span class="keyword">typeid</span></span>(*(var_type-&gt;<span class="built_in">ActualTy</span>())) == 				<span class="built_in"><span class="keyword">typeid</span></span>(type::RecordTy)) &#123;</span><br><span class="line">        <span class="keyword">return</span> type::NilTy::<span class="built_in">Instance</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (var_type &amp;&amp; <span class="built_in"><span class="keyword">typeid</span></span>(*(var_type)-&gt;<span class="built_in">ActualTy</span>()) == <span class="built_in"><span class="keyword">typeid</span></span>(type::IntTy)) &#123;</span><br><span class="line">        absyn::SimpleVar *simpleVar = <span class="keyword">dynamic_cast</span>&lt;SimpleVar *&gt;(var_);</span><br><span class="line">        <span class="keyword">if</span> (simpleVar != <span class="literal">nullptr</span>) &#123;</span><br><span class="line">            env::EnvEntry *envEntry = venv-&gt;<span class="built_in">Look</span>(simpleVar-&gt;sym_);</span><br><span class="line">            <span class="keyword">if</span> (envEntry != <span class="literal">nullptr</span>) &#123;</span><br><span class="line">                <span class="keyword">bool</span> readonly = envEntry-&gt;readonly_;</span><br><span class="line">                <span class="keyword">if</span> (readonly) &#123;</span><br><span class="line">                    errormsg-&gt;<span class="built_in">Error</span>(pos_, <span class="string">&quot;loop variable can&#x27;t be assigned&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (var_type &amp;&amp; exp_type &amp;&amp; <span class="built_in"><span class="keyword">typeid</span></span>(*(var_type-&gt;<span class="built_in">ActualTy</span>())) != <span class="built_in"><span class="keyword">typeid</span></span>(*(exp_type-&gt;<span class="built_in">ActualTy</span>()))) &#123;</span><br><span class="line">        errormsg-&gt;<span class="built_in">Error</span>(pos_, <span class="string">&quot; unmatched assign exp&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> type::NilTy::<span class="built_in">Instance</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-2-The-in-loop-checking-of-break-expression"><a href="#2-2-The-in-loop-checking-of-break-expression" class="headerlink" title="2.2 The in-loop checking of break expression"></a>2.2 The in-loop checking of break expression</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">type::Ty *<span class="title">ForExp::SemAnalyze</span><span class="params">(env::VEnvPtr venv, env::TEnvPtr tenv,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">int</span> labelcount, err::ErrorMsg *errormsg)</span> <span class="keyword">const</span> </span>&#123;</span><br><span class="line">	...</span><br><span class="line">    body_-&gt;<span class="built_in">SemAnalyze</span>(venv, tenv, labelcount + <span class="number">1</span>, errormsg);</span><br><span class="line">	...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">type::Ty *<span class="title">WhileExp::SemAnalyze</span><span class="params">(env::VEnvPtr venv, env::TEnvPtr tenv,</span></span></span><br><span class="line"><span class="params"><span class="function"><span class="keyword">int</span> labelcount, err::ErrorMsg *errormsg)</span> <span class="keyword">const</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    type::Ty *body_type = body_-&gt;<span class="built_in">SemAnalyze</span>(venv, tenv, labelcount + <span class="number">1</span>, errormsg);</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">type::Ty *<span class="title">BreakExp::SemAnalyze</span><span class="params">(env::VEnvPtr venv, env::TEnvPtr tenv,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">int</span> labelcount, err::ErrorMsg *errormsg)</span> <span class="keyword">const</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (labelcount == <span class="number">0</span>) &#123;</span><br><span class="line">    	errormsg-&gt;<span class="built_in">Error</span>(pos_, <span class="string">&quot;break is not inside any loop&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> type::NilTy::<span class="built_in">Instance</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-3-handle-the-nested-function-declaration"><a href="#2-3-handle-the-nested-function-declaration" class="headerlink" title="2.3 handle the nested function declaration"></a>2.3 handle the nested function declaration</h3><p>Tiger supports the adjacent nested function, so we need to define all the function name first in order for all the function to find the reference function entry in the venv. </p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">FunctionDec::SemAnalyze</span><span class="params">(env::VEnvPtr venv, env::TEnvPtr tenv,</span></span></span><br><span class="line"><span class="params"><span class="function"><span class="keyword">int</span> labelcount, err::ErrorMsg *errormsg)</span> <span class="keyword">const</span> </span>&#123;</span><br><span class="line">    absyn::FunDec *last_function = <span class="literal">nullptr</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (absyn::FunDec *function:functions_-&gt;<span class="built_in">GetList</span>()) &#123;</span><br><span class="line">        <span class="keyword">if</span> (last_function &amp;&amp; function-&gt;name_-&gt;<span class="built_in">Name</span>() == last_function-&gt;name_-&gt;<span class="built_in">Name</span>()) &#123;</span><br><span class="line">            errormsg-&gt;<span class="built_in">Error</span>(function-&gt;pos_, <span class="string">&quot;two functions have the same name&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        venv-&gt;<span class="built_in">Enter</span>(function-&gt;name_, <span class="keyword">new</span> env::<span class="built_in">FunEntry</span>(<span class="literal">nullptr</span>, <span class="literal">nullptr</span>));</span><br><span class="line">        last_function = function;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (absyn::FunDec *function:functions_-&gt;<span class="built_in">GetList</span>()) &#123;</span><br><span class="line">    	type::Ty *result_ty = tenv-&gt;<span class="built_in">Look</span>(function-&gt;result_);</span><br><span class="line">    	type::TyList *formals = function-&gt;params_-&gt;<span class="built_in">MakeFormalTyList</span>(tenv, errormsg);</span><br><span class="line">    	venv-&gt;<span class="built_in">Set</span>(function-&gt;name_, <span class="keyword">new</span> env::<span class="built_in">FunEntry</span>(formals, result_ty));</span><br><span class="line">    	venv-&gt;<span class="built_in">BeginScope</span>();</span><br><span class="line">    	<span class="keyword">auto</span> formal_it = formals-&gt;<span class="built_in">GetList</span>().<span class="built_in">begin</span>();</span><br><span class="line">    	<span class="keyword">auto</span> param_it = function-&gt;params_-&gt;<span class="built_in">GetList</span>().<span class="built_in">begin</span>();</span><br><span class="line">    	<span class="keyword">for</span> (; param_it != function-&gt;params_-&gt;<span class="built_in">GetList</span>().<span class="built_in">end</span>(); formal_it++, param_it++) &#123;</span><br><span class="line">        	venv-&gt;<span class="built_in">Enter</span>((*param_it)-&gt;name_, <span class="keyword">new</span> env::<span class="built_in">VarEntry</span>(*formal_it));</span><br><span class="line">    	&#125;</span><br><span class="line">    	type::Ty *ty = function-&gt;body_-&gt;<span class="built_in">SemAnalyze</span>(venv, tenv, labelcount, errormsg);</span><br><span class="line">    	errormsg-&gt;<span class="built_in">Error</span>(pos_, <span class="string">&quot;function body over&quot;</span>);</span><br><span class="line">    	<span class="keyword">if</span> (function-&gt;result_ == <span class="literal">nullptr</span> &amp;&amp; ty &amp;&amp; <span class="built_in"><span class="keyword">typeid</span></span>(*(ty-&gt;<span class="built_in">ActualTy</span>())) != <span class="built_in"><span class="keyword">typeid</span></span>(type::NilTy)) &#123;</span><br><span class="line">    		errormsg-&gt;<span class="built_in">Error</span>(pos_, <span class="string">&quot;procedure returns value&quot;</span>);</span><br><span class="line">    	&#125;</span><br><span class="line">    	venv-&gt;<span class="built_in">EndScope</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-4-illegal-cycle-in-nested-type-declaration"><a href="#2-4-illegal-cycle-in-nested-type-declaration" class="headerlink" title="2.4 illegal cycle in nested type declaration"></a>2.4 illegal cycle in nested type declaration</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// test.16.tig</span></span><br><span class="line"><span class="comment">/* error: mutually recursive types thet do not pass through record or array */</span></span><br><span class="line">let </span><br><span class="line"></span><br><span class="line">type a=c</span><br><span class="line">type b=a</span><br><span class="line">type c=d</span><br><span class="line">type d=a</span><br><span class="line"></span><br><span class="line">in</span><br><span class="line"> <span class="string">&quot;&quot;</span></span><br><span class="line">end</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>The upper code is not allowed in tiger language, so we need to check if there is a cycle in type nested declaration. Each time we define a new type, we need to scan the defined type in the venv to make sure there is no cycle.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">TypeDec::SemAnalyze</span><span class="params">(env::VEnvPtr venv, env::TEnvPtr tenv, <span class="keyword">int</span> labelcount,</span></span></span><br><span class="line"><span class="params"><span class="function">err::ErrorMsg *errormsg)</span> <span class="keyword">const</span> </span>&#123;</span><br><span class="line">	<span class="keyword">for</span> (NameAndTy* current: types_-&gt;<span class="built_in">GetList</span>()) &#123;   <span class="comment">// put all the name into the env first</span></span><br><span class="line">		sym::Symbol *symbol = current-&gt;name_;</span><br><span class="line">		<span class="keyword">for</span> (NameAndTy* current_2: types_-&gt;<span class="built_in">GetList</span>()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (current_2 == current) <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">if</span> (current_2-&gt;name_-&gt;<span class="built_in">Name</span>() == current-&gt;name_-&gt;<span class="built_in">Name</span>()) &#123;</span><br><span class="line">            	errormsg-&gt;<span class="built_in">Error</span>(pos_, <span class="string">&quot;two types have the same name&quot;</span>);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		tenv-&gt;<span class="built_in">Enter</span>(symbol, <span class="keyword">new</span> type::<span class="built_in">NameTy</span>(symbol, <span class="literal">nullptr</span>));</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">for</span> (NameAndTy* current: types_-&gt;<span class="built_in">GetList</span>()) &#123;</span><br><span class="line">        sym::Symbol *symbol = current-&gt;name_;</span><br><span class="line">        errormsg-&gt;<span class="built_in">Error</span>(pos_, <span class="string">&quot;define symbol &quot;</span> + symbol-&gt;<span class="built_in">Name</span>());</span><br><span class="line">        absyn::Ty* type = current-&gt;ty_;</span><br><span class="line">        absyn::NameTy *changed_type1 = <span class="keyword">dynamic_cast</span>&lt;absyn::NameTy *&gt;(type);</span><br><span class="line">        absyn::ArrayTy *changed_type2 = <span class="keyword">dynamic_cast</span>&lt;absyn::ArrayTy *&gt;(type);</span><br><span class="line">        absyn::RecordTy *changed_type3 = <span class="keyword">dynamic_cast</span>&lt;absyn::RecordTy *&gt;(type);</span><br><span class="line">        <span class="keyword">if</span> (changed_type1 != <span class="literal">nullptr</span>) &#123;</span><br><span class="line">			type::Ty *type1 = changed_type1-&gt;<span class="built_in">SemAnalyze</span>(tenv, errormsg);</span><br><span class="line">			tenv-&gt;<span class="built_in">Set</span>(symbol, type1);</span><br><span class="line">			<span class="keyword">try</span> &#123;</span><br><span class="line">				type::Ty * test_type = tenv-&gt;<span class="built_in">Look</span>(symbol);</span><br><span class="line">                type::NameTy * change_one = <span class="keyword">dynamic_cast</span>&lt;type::NameTy *&gt;(test_type);</span><br><span class="line">                type::NameTy * origin_one = <span class="keyword">dynamic_cast</span>&lt;type::NameTy *&gt;(test_type);</span><br><span class="line">                <span class="keyword">while</span> (change_one != <span class="literal">nullptr</span>) &#123;</span><br><span class="line">                	errormsg-&gt;<span class="built_in">Error</span>(pos_, <span class="string">&quot;change_one= &quot;</span> + change_one-&gt;sym_-&gt;<span class="built_in">Name</span>());</span><br><span class="line">                	change_one = <span class="keyword">dynamic_cast</span>&lt;type::NameTy *&gt;(change_one-&gt;ty_);</span><br><span class="line">                	<span class="keyword">if</span> (change_one == origin_one) &#123;</span><br><span class="line">                		errormsg-&gt;<span class="built_in">Error</span>(pos_, <span class="string">&quot;eeee= &quot;</span> + change_one-&gt;sym_-&gt;<span class="built_in">Name</span>());</span><br><span class="line">                		<span class="keyword">throw</span>(<span class="number">0</span>);</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="built_in"><span class="keyword">catch</span></span> (...) &#123;</span><br><span class="line">				errormsg-&gt;<span class="built_in">Error</span>(pos_, <span class="string">&quot;illegal type cycle&quot;</span>);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> (changed_type2 != <span class="literal">nullptr</span>) &#123;</span><br><span class="line">			type::Ty *type2 = changed_type2-&gt;<span class="built_in">SemAnalyze</span>(tenv, errormsg);</span><br><span class="line">			tenv-&gt;<span class="built_in">Set</span>(symbol, type2);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> (changed_type3 != <span class="literal">nullptr</span>) &#123;</span><br><span class="line">			type::Ty *type3 = changed_type3-&gt;<span class="built_in">SemAnalyze</span>(tenv, errormsg);</span><br><span class="line">			tenv-&gt;<span class="built_in">Set</span>(symbol, type3);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><div class="article-licensing box"><div class="licensing-title"><p>complier-lab4</p><p><a href="https://kami-code.com/2021/11/22/complier-lab4/">https://kami-code.com/2021/11/22/complier-lab4/</a></p></div><div class="licensing-meta level is-mobile"><div class="level-left"><div class="level-item is-narrow"><div><h6>Author</h6><p>Kami-code</p></div></div><div class="level-item is-narrow"><div><h6>Posted on</h6><p>2021-11-22</p></div></div><div class="level-item is-narrow"><div><h6>Updated on</h6><p>2021-11-22</p></div></div><div class="level-item is-narrow"><div><h6>Licensed under</h6><p><a class="icons" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="icon fab fa-creative-commons"></i></a><a class="icons" rel="noopener" target="_blank" title="Attribution" href="https://creativecommons.org/licenses/by/4.0/"><i class="icon fab fa-creative-commons-by"></i></a><a class="icons" rel="noopener" target="_blank" title="Noncommercial" href="https://creativecommons.org/licenses/by-nc/4.0/"><i class="icon fab fa-creative-commons-nc"></i></a></p></div></div></div></div></div><div class="article-tags is-size-7 mb-4"><span class="mr-2">#</span><a class="link-muted mr-2" rel="tag" href="/tags/lab/">lab</a><a class="link-muted mr-2" rel="tag" href="/tags/compliers/">compliers</a></div><!--!--></article></div><!--!--><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/2021/11/22/SE3353-assignment8/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">SE3353-assignment8</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2021/11/06/ikfast-configuration/"><span class="level-item">ikfast-configuration</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><div class="card"><div class="card-content"><h3 class="title is-5">Comments</h3><div id="SOHUCS" sid="2021/11/22/complier-lab4/"></div><script charset="utf-8" src="https://changyan.sohu.com/upload/changyan.js"></script><script>window.changyan.api.config({appid: 'cyvI88c19',conf: 'prod_634561f1ec380218934dcf2c12b8b70b'});</script></div></div></div><div class="column column-left is-4-tablet is-4-desktop is-4-widescreen  order-1"><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar" src="/img/avatar.jpg" alt="Chen Bao"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">Chen Bao</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>Shanghai, China</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">Posts</p><a href="/archives"><p class="title">20</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Categories</p><a href="/categories"><p class="title">0</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Tags</p><a href="/tags"><p class="title">29</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://github.com/Kami-code" target="_blank" rel="noopener">Follow</a></div><div class="level is-mobile is-multiline"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/Kami-code"><i class="fab fa-github"></i></a></div></div></div><!--!--><div class="card widget" data-type="links"><div class="card-content"><div class="menu"><h3 class="menu-label">Links</h3><ul class="menu-list"><li><a class="level is-mobile" href="https://hexo.io" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Hexo</span></span><span class="level-right"><span class="level-item tag">hexo.io</span></span></a></li><li><a class="level is-mobile" href="https://bulma.io" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Bulma</span></span><span class="level-right"><span class="level-item tag">bulma.io</span></span></a></li></ul></div></div></div><!--!--><div class="card widget" data-type="recent-posts"><div class="card-content"><h3 class="menu-label">Recents</h3><article class="media"><div class="media-content"><p class="date"><time dateTime="2022-01-17T06:39:59.000Z">2022-01-17</time></p><p class="title"><a href="/2022/01/17/machine-learning-pre/">VoteNet_pre</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-12-22T12:03:50.000Z">2021-12-22</time></p><p class="title"><a href="/2021/12/22/pointnet-and-related-works/">pointnet_and_related_works</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-12-20T02:39:49.000Z">2021-12-20</time></p><p class="title"><a href="/2021/12/20/screwnet/">(ICRA2021)ScrewNet</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-12-18T12:22:36.000Z">2021-12-18</time></p><p class="title"><a href="/2021/12/18/SE3353-assignment10/">SE3353-assignment10</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-12-14T09:13:44.000Z">2021-12-14</time></p><p class="title"><a href="/2021/12/14/complier-lab5/">complier-lab5</a></p></div></article></div></div><div class="card widget" data-type="archives"><div class="card-content"><div class="menu"><h3 class="menu-label">Archives</h3><ul class="menu-list"><li><a class="level is-mobile" href="/archives/2022/01/"><span class="level-start"><span class="level-item">January 2022</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/12/"><span class="level-start"><span class="level-item">December 2021</span></span><span class="level-end"><span class="level-item tag">6</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/11/"><span class="level-start"><span class="level-item">November 2021</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/10/"><span class="level-start"><span class="level-item">October 2021</span></span><span class="level-end"><span class="level-item tag">8</span></span></a></li></ul></div></div></div><div class="card widget" data-type="tags"><div class="card-content"><div class="menu"><h3 class="menu-label">Tags</h3><div class="field is-grouped is-grouped-multiline"><div class="control"><a class="tags has-addons" href="/tags/CHOMP/"><span class="tag">CHOMP</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Camera/"><span class="tag">Camera</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Docker/"><span class="tag">Docker</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ICRA/"><span class="tag">ICRA</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/MongoDB/"><span class="tag">MongoDB</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/MySQL/"><span class="tag">MySQL</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Neo4j/"><span class="tag">Neo4j</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/OpenCV/"><span class="tag">OpenCV</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/OpenGL/"><span class="tag">OpenGL</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/PointNet/"><span class="tag">PointNet</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/PointNet/"><span class="tag">PointNet++</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Pybind11/"><span class="tag">Pybind11</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Pybullet/"><span class="tag">Pybullet</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ROS/"><span class="tag">ROS</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/SE3353/"><span class="tag">SE3353</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ScrewNet/"><span class="tag">ScrewNet</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Search/"><span class="tag">Search</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/VoteNet/"><span class="tag">VoteNet</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/WebService/"><span class="tag">WebService</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/behavior-tree/"><span class="tag">behavior tree</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/compliers/"><span class="tag">compliers</span><span class="tag">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/deeplearning/"><span class="tag">deeplearning</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/ikfast/"><span class="tag">ikfast</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/lab/"><span class="tag">lab</span><span class="tag">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/mmdection/"><span class="tag">mmdection</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/moveit/"><span class="tag">moveit</span><span class="tag">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/planning/"><span class="tag">planning</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/pybullet/"><span class="tag">pybullet</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/segmentation/"><span class="tag">segmentation</span><span class="tag">1</span></a></div></div></div></div></div><div class="card widget" data-type="subscribe-email"><div class="card-content"><div class="menu"><h3 class="menu-label">Subscribe for updates</h3><form action="https://feedburner.google.com/fb/a/mailverify" method="post" target="popupwindow" onsubmit="window.open(&#039;https://feedburner.google.com/fb/a/mailverify?uri=&#039;,&#039;popupwindow&#039;,&#039;scrollbars=yes,width=550,height=520&#039;);return true"><input type="hidden" value="" name="uri"><input type="hidden" name="loc" value="en_US"><div class="field has-addons"><div class="control has-icons-left is-expanded"><input class="input" name="email" type="email" placeholder="Email"><span class="icon is-small is-left"><i class="fas fa-envelope"></i></span></div><div class="control"><input class="button" type="submit" value="Subscribe"></div></div></form></div></div></div><div class="card widget" data-type="subscribe-email"><div class="card-content"><div class="menu"><h3 class="menu-label">follow.it</h3><form action="" method="post" target="_blank"><div class="field has-addons"><div class="control has-icons-left is-expanded"><input class="input" name="email" type="email" placeholder="Email"><span class="icon is-small is-left"><i class="fas fa-envelope"></i></span></div><div class="control"><input class="button" type="submit" value="Subscribe"></div></div></form></div></div></div></div><!--!--></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/logo.svg" alt="Ryan &#039;s website" height="28"></a><span id="busuanzi_container_site_pv">本站总访问量<span id="busuanzi_value_site_pv"></span>次</span><span class="post-meta-divider">|</span><span id="busuanzi_container_site_uv" style="display:none">本站访客数<span id="busuanzi_value_site_uv"></span>人</span><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><p class="is-size-7"><span>&copy; 2022 Kami-code</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("en");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="Back to top" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "This website uses cookies to improve your experience.",
          dismiss: "Got it!",
          allow: "Allow cookies",
          deny: "Decline",
          link: "Learn more",
          policy: "Cookie Policy",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><script type="text/x-mathjax-config">MathJax.Hub.Config({
            'HTML-CSS': {
                matchFontHeight: false
            },
            SVG: {
                matchFontHeight: false
            },
            CommonHTML: {
                matchFontHeight: false
            },
            tex2jax: {
                inlineMath: [
                    ['$','$'],
                    ['\\(','\\)']
                ]
            }
        });</script><script src="https://cdn.jsdelivr.net/npm/mathjax@2.7.5/unpacked/MathJax.js?config=TeX-MML-AM_CHTML" defer></script><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="Type something..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"Type something...","untitled":"(Untitled)","posts":"Posts","pages":"Pages","categories":"Categories","tags":"Tags"});
        });</script></body></html>